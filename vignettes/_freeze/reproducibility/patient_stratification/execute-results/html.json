{
  "hash": "02e2eba501ddad0f3342e2f3710ff5d5",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Patient stratification\"\n---\n\n\nThe list of packages required for reproducing the analyses on this script are listed in @lst-setup-patient-stratification. Besides, the downloadable R script file [`utils`](../../scripts/utils.R) stores two helper functions:\n\n- `get_legend_temp` is a temporary fix to retrieve the legend of any `ggplot2` or `grob` object (used for further customisation of a panel of subplots). For further details on this custom fix, report to [Open `Cowplot` Issue for shared legend feature](https://github.com/wilkelab/cowplot/issues/202).\n- `colourer` is a custom styling function displaying all positive values as *red*, and negative ones as *blue* (used with `flextable`).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{#lst-setup-patient-stratification .r .cell-code  lst-cap=\"Packages required for analysing biological differences between patient conditions.\"}\nlibrary(CoRC)\n\n# Data wrangling\nlibrary(dplyr)\nlibrary(readr)\n\n# Table visualisation\nlibrary(scales)\nlibrary(flextable)\n\n# Plot visualisation\nlibrary(ggplot2)\nlibrary(latex2exp)\nlibrary(cowplot)\n\nsource(\"../../scripts/utils.R\")\n```\n:::\n\n\n## Parameter estimation and patient stratification\n\n\nTo run an experimental design, we need:\n  \n  - the model itself, and notably the steady-state concentrations, and the parameter constants. \n- Experimental data, where for a given condition (here, patient cluster), the columns correspond to the species concentrations, and the rows to the indiviudal observations. Real-life measures of fold changes have been reported in @tbl-experiment-data.\n- The R code used for loading the healthy model and the clinical datasets, is reported in @lst-load-experiences^[note the final `split()` instruction: indeed, the expected input is a list of experiences, each element of the list matching a subgroup of patients with their own set of free parameters].\n\n### Differential analyses\n\n**Note that @lo2016po did not provide unfortunately the individual cytokine concentrations, preventing from reproducing the differential analyses and quite hampering the validity of [Parameter estimation](https://copasi.org/Support/User_Manual/Tasks/Parameter_Estimation/) Task.**\n  \n\n::: {.cell layout-align=\"center\"}\n\n```{#lst-load-experiences .r .cell-code  lst-cap=\"Code snippet not run, used for illustration example.\"}\n# Load Healthy ODE model along with the parameter constants\nhealthy_model <- loadModel(\"../../models/team_2016_final_model_lo2016_2025_05_13.cps\")\nhealthy_steaty_state <- runSteadyState(\n  calculate_jacobian = FALSE,\n  model = healthy_model\n)$species |>\n  dplyr::select(name, concentrationH = concentration)\n\n# Load experimental datasets providing real-life concentrations of cytokines\ncluster_type <- c(\"Type 1\", \"Type 2\", \"Type 3\", \"Type 4\")\ndata_experiment <- readr::read_csv(\"../../data/IBD DGEA.csv\", show_col_types = FALSE) |>\n  tidyr::pivot_longer(!cluster, names_to = \"name\", values_to = \"concentration\") |>\n  dplyr::left_join(healthy_steaty_state, by = \"name\") |>\n  mutate(\n    concentration = if_else(!is.na(concentrationH),\n                            concentrationH * (1 + concentration / 100), concentration\n    ),\n    concentrationH = NULL\n  ) |>\n  tidyr::pivot_wider(names_from = name, values_from = concentration) |>\n  split(f = cluster_type)\n\n```\n:::\n\n\n\n\n::: {#tbl-experiment-data .cell layout-align=\"center\" tbl-cap='Fold changes of *cytokine* concentrations obtained from clinical data, reported in *Table 7*, [@lo2016po, pp. 13]. `Species` is the cytokines\\' name,  while cluster indicator is returned by `Types of disease`. Note that we have not reported species concentrations of $T-Bet$, $Gata3$, $ROR \\gamma t$, and $Foxp3$ as not measured in the ODE model.'}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"tabwid\"><style>.cl-9488ae0e{}.cl-94744f18{font-family:'Arial';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-94744f36{font-family:'Arial';font-size:6.6pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;position: relative;bottom:3.3pt;}.cl-947cabe0{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-947cabf4{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-947d2e26{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-947d2e44{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-947d2e45{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-947d2e4e{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-947d2e62{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-947d2e63{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-947d2e6c{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(255, 255, 255, 0.00);border-top: 0 solid rgba(255, 255, 255, 0.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing='true' class='cl-9488ae0e'><thead><tr style=\"overflow-wrap:break-word;\"><th class=\"cl-947d2e26\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Types of disease</span></p></th><th class=\"cl-947d2e26\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Species</span></p></th><th class=\"cl-947d2e26\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Species' concentration at steady-state</span></p></th><th class=\"cl-947d2e26\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Concentrations in IBD clusters</span></p></th><th class=\"cl-947d2e44\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">fold change</span></p></th></tr></thead><tbody><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 1</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">I6</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.46e-06</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.02e-07</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-93.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 1</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">I10</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">3.01e-08</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.48e-08</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-51.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 1</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Ia</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">2.72e-05</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.88e-05</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-31.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 1</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Ib</span><span class=\"cl-94744f36\">*</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.64e-13</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">7.23e-14</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-56.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 1</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Ig</span><span class=\"cl-94744f36\">*</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">2.01e-07</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">2.01e-09</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-99.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 2</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">I6</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.46e-06</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">3.78e-07</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-74.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 2</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">I10</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">3.01e-08</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">2.56e-08</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-15.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 2</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Ia</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">2.72e-05</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.88e-05</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-31.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 2</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Ib</span><span class=\"cl-94744f36\">*</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.64e-13</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.54e-13</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-6.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 2</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Ig</span><span class=\"cl-94744f36\">*</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">2.01e-07</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.61e-08</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-92.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 3</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">I6</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.46e-06</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.96e-06</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">35.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 3</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">I10</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">3.01e-08</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">4.34e-08</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">44.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 3</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Ia</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">2.72e-05</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">4.00e-05</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">47.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 3</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Ib</span><span class=\"cl-94744f36\">*</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.64e-13</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.95e-13</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">19.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 3</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Ig</span><span class=\"cl-94744f36\">*</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">2.01e-07</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.17e-06</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">481.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 4</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">I6</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.46e-06</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">2.47e-07</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-83.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 4</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">I10</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">3.01e-08</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.99e-08</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-34.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 4</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Ia</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">2.72e-05</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.49e-05</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-45.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 4</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Ib</span><span class=\"cl-94744f36\">*</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.64e-13</span></p></td><td class=\"cl-947d2e45\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.31e-13</span></p></td><td class=\"cl-947d2e4e\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-20.0%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-947d2e62\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">type 4</span></p></td><td class=\"cl-947d2e62\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">Ig</span><span class=\"cl-94744f36\">*</span></p></td><td class=\"cl-947d2e62\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">2.01e-07</span></p></td><td class=\"cl-947d2e62\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f18\">1.00e-08</span></p></td><td class=\"cl-947d2e63\"><p class=\"cl-947cabf4\"><span class=\"cl-94744f18\">-95.0%</span></p></td></tr></tbody><tfoot><tr style=\"overflow-wrap:break-word;\"><td  colspan=\"5\"class=\"cl-947d2e6c\"><p class=\"cl-947cabe0\"><span class=\"cl-94744f36\">*</span><span class=\"cl-94744f18\">These quantities have not been measured, but rather estimated from the model.</span></p></td></tr></tfoot></table></div>\n```\n\n:::\n:::\n\n\n### Configure the experimental design and the numerical optimisations\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# define larger lower and upper bounds\nfree_parameters_key <- getParameters(c(\n  \"(Prod of Ig from T1).k1\",\n  \"(Prod of Ia from T1).k1\",\n  \"(Prod of Ib from Tr).k1\",\n  \"(Prod of I10 from Tr).v10r\",\n  \"(Induction of T1 from M).s12\",\n  \"(Induction of T2).s4\",\n  \"(Induction of T17).s21\",\n  \"(Induction of T17).s6\",\n  \"(Induction of Tr).sb\",\n  \"(Induction of Tr).s10\"\n), model = healthy_model)$key\n\n\nfit_parameters <- purrr::map(free_parameters_key, function(param) {\n  val <- getParameters(param)$value\n  defineParameterEstimationParameter(\n    ref = parameter(param, \"Value\"),\n    start_value = val,\n    lower_bound = 1e-15,\n    upper_bound = 1e4\n  )\n})\n\nmapping_present <- getSpeciesReferences(\n  key = c(\"I6\", \"I10\", \"Ia\", \"Ib\", \"Ig\"),\n  model = healthy_model\n) |> pull(concentration)\n\nfit_experiments <- purrr::map(data_experiment, ~ defineExperiments(\n  experiment_type = \"steady_state\",\n  data = .x,\n  types = c(\n    \"ignore\", \"dependent\", \"dependent\", \"dependent\",\n    \"ignore\", \"ignore\", \"ignore\", \"ignore\", \"ignore\", \"ignore\"\n  ),\n  mappings = c(NA, mapping_present,  rep(NA, 4)),\n  weight_method = \"mean_square\"\n))\n```\n:::\n\n\n\n```r\nfree_parameters_key <- getParameters(c(\"(Prod of Ig from T1).k1\",          # <1>\n                                       \"(Prod of Ia from T1).k1\",          # <1>                             \n                                       \"(Prod of Ib from Tr).k1\",          # <1>\n                                       \"(Prod of I10 from Tr).v10r\",       # <1>\n                                       \"(Induction of T1 from M).s12\",     # <1>\n                                       \"(Induction of T2).s4\",             # <1>\n                                       \"(Induction of T17).s21\",           # <1>\n                                       \"(Induction of T17).s6\",            # <1>\n                                       \"(Induction of Tr).sb\",              # <1>\n                                       \"(Induction of Tr).s10\"), model = healthy_model)$key # <1>\n\nfit_parameters <- purrr::map(free_parameters_key, function(param) {        # <2>\n  val <- getParameters(param)$value                                        # <2>\n  defineParameterEstimationParameter(                                      # <2>\n    ref = parameter(param, \"Value\"),                                       # <2>\n    start_value = val,                                                     # <2>\n    lower_bound = 1e-15,                                                   # <2>\n    upper_bound = 1e4)                                                     # <2>\n})                                                                         # <2>\n\nmapping_present <- getSpeciesReferences(\n  key = c(\"I6\", \"I10\", \"Ia\", \"Ib\", \"Ig\"),\n  model = healthy_model\n) |> pull(concentration)\n\nfit_experiments <- purrr::map(data_experiment, ~ defineExperiments( # <3>\n  experiment_type = \"steady_state\", # <3>\n  data = .x, # <3>\n  types = c( # <3>\n    \"ignore\", \"dependent\", \"dependent\", \"dependent\", # <3>\n    \"ignore\", \"ignore\", \"ignore\", \"ignore\", \"ignore\", \"ignore\"), # <3>\n  mappings = c(NA, mapping_present,  rep(NA, 4)), # <4>\n  weight_method = \"mean_square\" # <5>\n))            # <3>                 \n```\n1. To adjust the variations of steady-state concentrations observed in the identified four subgroups of patients suffering from Inflammatory Bowel Disease, @lo2016po chose to play with 10 biological constants (10 degrees of freedom). Note that for the system of equations to be **determined** (at the very least), the number of free parameters to estimate must be equal or inferior to the number of equations (here, one by species included in the ODE model, aka 15).\n2. We initialise the iterative search by initialising the 10 free parameters with the biological constant vitals observed in healthy inviduals. Besides, we can enforce bounds (either for each of the parameters, or shared by all of them), coercing the optimisation algorithm not to go beyond. \n3. For each of the patient subgroups, we need to provide the type of experiment (either `steady-state`, or `time_course` when several time points have been considered in the design), the measured concentrations diverging from the average concentrations in healthy patients with `data`, define each of the measured variables  (constant with `independent`, `dependent` if used for tailoring the parameter estimates, or `ignore` if not quantified in the ODE model). We had only the averaged expression per patient subgroup To better capture within-patient variability, it would have been valuable to provide the individual cytokine profiles, and perform a [**multiple least-squares regression, aka MMR**](https://en.wikipedia.org/wiki/General_linear_model) task.\n4. `mappings` guarantees the proper pairing between COPASI variables and string values of column names^[In contrast with documentation, this step seems mandatory, as the output returned by `` has a **placeholder** typical syntax.].\n5. Finally, the [`weight_method`] coupled with `weights` describe for each variable the assumed mean-variation trend. Report to COPASI Manual, section [*Experimental Data*](https://copasi.org/Support/User_Manual/Tasks/Parameter_Estimation/Experimental_Data/), for further details. \n\n\nFinally, once the experimental design and optimisation criterias have been configured independently for each free parameter and patient subgroup, we have to run the parameter estimation itself:\n  \n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nabsolute_parameter_per_cluster <- purrr::map(fit_experiments, function(cluster) {\n  # CoRC update imposes to restart from a clean model for parameter estimation\n  CoRC::clearParameterEstimationParameters(model = healthy_model)\n  CoRC::clearExperiments(model = healthy_model)\n  \n  return(runParameterEstimation(\n    parameters = fit_parameters,\n    experiments = cluster,\n    method = list(\n      method = \"LevenbergMarquardt\",\n      log_verbosity = 0, \n      iteration_limit = 200,\n      tolerance = 1e-5\n    ),\n    update_model = FALSE, \n    randomize_start_values = FALSE,\n    create_parameter_sets = TRUE,\n    calculate_statistics = FALSE,\n    model = healthy_model\n  )$parameters)\n})\n\n# Make results directly comparable with Table 8 by switchign from absolute to relative ratios\nrelative_parameter_per_cluster <- absolute_parameter_per_cluster |> \n  purrr::list_rbind(names_to = \"cluster\") |> \n  dplyr::select(cluster, parameter, start_value, value) |> \n  mutate (relative_concentration = 100*(value - start_value)/start_value,\n          start_value = NULL, value = NULL) |> \n  tidyr::pivot_wider(names_from = parameter, values_from = relative_concentration) \n```\n:::\n\n\n\n\n\n\n```r\nabsolute_parameter_per_cluster <- purrr::map(fit_experiments, function(cluster) { # <1>\n  CoRC::clearParameterEstimationParameters(model = healthy_model)   # <2>\n  CoRC::clearExperiments(model = healthy_model)                     # <2>\n  return(runParameterEstimation(                             # <3>\n    parameters = fit_parameters, # <3>\n    experiments = cluster, # <3>\n    method = list(method = \"LevenbergMarquardt\",   # <4>\n                  iteration_limit = 500,   # <4>\n                  tolerance = 1e-6),   # <4>\n    update_model = FALSE, # <3>\n    randomize_start_values = FALSE, # <3>\n    create_parameter_sets = TRUE,  # <3>\n    calculate_statistics = FALSE,  # <3>\n    model = healthy_model  # <3>\n  )$parameters)\n})\n```\n1. We learn a configuration of 10 free parameters independently for each patient subgroup. \n2. Recall that in COPASI, models are modified by reference rather than by copy. These auxiliary functions, `clearParameterEstimationParameters` and `clearExperiments` guarantee a fresh start for parameter estimation for each scenario. \n3. The core function, `runParameterEstimation`, of the pipeline for estimating varying constants across distinct biological conditions. \n4. There are plenty of optimisation approaches to reduce the discrepancy between the healthy-state concentrations of immune cells, and the ones observed across each patient cluster, listed in [Optimization Methods](https://copasi.org/Support/User_Manual/Methods/Optimization_Methods/). **Unfortunately, the precise optimisation method used in @lo2016po has not been detailed, nor the hyperparameters used.** We arbitrarily chose the [Levenberg - Marquardt](https://copasi.org/Support/User_Manual/Methods/Optimization_Methods/Levenberg_-_Marquardt/) approach that is a good compromise between first-order, steepest descent approaches, and second-order, Newton-Raphson like approaches (see @tip-optimisation for details). The `iteration_limit` determines the maximum number of iterations the algorithm shall perform, while `tolerance` is the numerical precision to reach between two consecutive iterations.\n\n\n::: {#tip-optimisation .callout-tip title=\"Optimisation Descent Methods\" collapse=\"true\"}\n  \nConsider a multivariate function $f(\\mathbf{x})$ that we want to **maximize** with respect to $\\mathbf{x}$ (for instance, we may want to minimise the mean-squared error between estimated steady-state concentrations and ones measured in each patient subgroup). Standard unconstrained optimization approaches include *Gradient Descent* (see [@eq-GD]), *Newton-Raphson* (see [@eq-NR]) and *Levenbergh-Marquart* (see [@eq-LM]):\n\n---\n\nThe **Steepest Descent Approach**, where the method updates $\\mathbf{x}$ in the direction of the gradient (steepest slope):  \n\n$$\n\\mathbf{x}_{k+1} = \\mathbf{x}_k + \\alpha_k \\nabla f(\\mathbf{x}_k)\n$${#eq-GD}\n\nwhere:  \n\n- $\\nabla f(\\mathbf{x}_k)$ is the gradient of $f$ at $\\mathbf{x}_k$,  \n- $\\alpha_k$ is the **step size (learning rate)**, sometimes fixed. Playing on this parameter may prevent revolving round the optimum.  \n- **The steepest descent method only converges linearly, but is guaranteed to converge.**\n\n---\n\nThe **Newton-Raphson Approach** is a second-order method, requiring the computation of the *Hessian matrix*:  \n\n$$\n\\mathbf{x}_{k+1} = \\mathbf{x}_k +  \\mathbf{H}^{-1}(\\mathbf{x}_k) \\nabla f(\\mathbf{x}_k)\n$${#eq-NR}\n\nwhere:  \n\n- $\\mathbf{H}(\\mathbf{x}_k) = \\nabla^2 f(\\mathbf{x}_k)$ is the Hessian matrix,  \n- $\\nabla f(\\mathbf{x}_k)$ is the gradient.\n\n**On the other hand, the Newton method converges quadratically towards the minimum in its vicinity. However, it's really sensible to the initialisation, and may not converge at all if it is far away from it**.\n\n---\n\nThe **Levenberg-Marquardt Descent Approach** blends Newton’s method with a trust-region adjustment, controlling step size:\n\n$$\n\\mathbf{x}_{k+1} = \\mathbf{x}_k + \\left( \\mathbf{H}(\\mathbf{x}_k) + \\lambda \\mathbf{I} \\right)^{-1} \\nabla f(\\mathbf{x}_k)\n$${#eq-LM}\n\nwhere $\\lambda$ controls the trade-off between gradient descent, when $\\lambda \\to \\infty$, and Newton’s method $\\lambda \\to 0$.  \n\n:::\n\n\n### Reporting of parameter estimations{#sec-parameter-estimation}\n\nOur estimations are compared with *Table 8*, [@lo2016po, pp. 13] variations in @tbl-parameter-estimation. \n\n**Of note, all tables in the original paper were provided as screenshots and images, rather than CSV files, preventing straightforward reporducibility of the results**.\n\n\n\n::: {#tbl-parameter-estimation .cell layout-align=\"center\" tbl-cap='Estimation of parameter variations in different patient subgroups, reported in *Table 8*, [@lo2016po, pp. 13]^[[Webshot table](https://doi.org/10.1371/journal.pone.0165782.t008)].'}\n\n```{.r .cell-code}\n# flextable formatting and variables\nvariable_labels <- list(\n  cluster = \"Type of diseases\",\n  `(Prod of Ig from T1).k1` = \"coefficient of IFN-gamma by Th1\", \n  `(Prod of Ia from T1).k1` = \"coefficient of TNF-alpha by Th1\", \n  `(Prod of Ib from Tr).k1` = \"coefficient of TGF-beta by Treg\",\n  `(Prod of I10 from Tr).v10r` = \"coefficient of IL-10 by Treg\",\n  `(Induction of T1 from M).s12` = \"activation of Th1 cells\", \n  `(Induction of T2).s4` = \"activation of Th2 cells\", \n  `(Induction of T17).s21` = \"activation of Th17 cells\",\n  `(Induction of T17).s6` = \"activation of Th17 cells\", \n  `(Induction of Tr).sb` = \"activation of Treg cells\",\n  `(Induction of Tr).s10` = \"activation of Treg cells\"\n)\nheader_row <- c(\n  \"\\\\text{Type of diseases}\",\n  \"\\\\nu_{\\\\gamma_1}\",\n  \"\\\\nu_{\\\\alpha_1}\", \n  \"\\\\nu_{\\\\beta_{\\\\rho}}\",\n  \"\\\\nu_{10_{\\\\rho}}\",\n  \"\\\\sigma_{12}\",\n  \"\\\\sigma_{4}\",\n  \"\\\\sigma_{21}\",\n  \"\\\\sigma_{6}\",\n  \"\\\\sigma_{\\\\beta}\",\n  \"\\\\sigma_{10}\") |> \n  as_equation() |>\n  as_paragraph()\n\n# flextable generation\n\nrelative_parameter_variations_flextable <- flextable(relative_parameter_per_cluster) |> \n  # Add gradient colouring based on values\n  bg(\n    j = setdiff(names(variable_labels), \"cluster\"), \n    bg = colourer) |> \n  # Format numbers (optional for consistent display)\n  colformat_double(j = setdiff(names(variable_labels), \"cluster\"),\n                   suffix = \"%\",\n                   big.mark = \",\", \n                   digits = 1) |> \n  append_chunks(j = \"cluster\",\n                # what to append\n                as_equation(c(\"\\\\text{Th1}\\\\uparrow \\\\text{Th2}\\\\downarrow\",\n                              \"\\\\text{Th1}\\\\downarrow \\\\text{Th2}\\\\uparrow\", \n                              \"\\\\text{Th1}\\\\uparrow \\\\text{Th2}\\\\uparrow\",\n                              \"\\\\text{Th1}\\\\downarrow \\\\text{Th2}\\\\downarrow\"))\n  ) |> \n  # Rename columns using LaTeX-like notation\n  set_header_labels(values = variable_labels\n  ) |> \n  add_header_row(values = header_row,\n                 colwidths = rep(1, 11), top = FALSE\n  ) |> \n  align(align = \"center\", part = \"all\") |> \n  set_caption(\"Table 8: Parameter variations in different types of diseases. \n              In blue, disease subtype induces shrinkage of the coefficients, \n              while red values correspond to increased parameter uptakes. \") |>\n  merge_at(part = \"head\", i = 1:2, j= 1)\nrelative_parameter_variations_flextable\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"tabwid\"><style>.cl-e017a01e{}.cl-e004b242{font-family:'Arial';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-e00c9fc0{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-e00cf9e8{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cf9fc{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cf9fd{width:0.75in;background-color:rgba(255, 255, 255, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa06{width:0.75in;background-color:rgba(252, 249, 255, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa10{width:0.75in;background-color:rgba(170, 129, 255, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa11{width:0.75in;background-color:rgba(255, 157, 128, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa1a{width:0.75in;background-color:rgba(252, 250, 255, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa24{width:0.75in;background-color:rgba(255, 125, 92, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa25{width:0.75in;background-color:rgba(0, 0, 255, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa2e{width:0.75in;background-color:rgba(255, 113, 79, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa38{width:0.75in;background-color:rgba(220, 196, 255, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa42{width:0.75in;background-color:rgba(251, 249, 255, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa43{width:0.75in;background-color:rgba(193, 158, 255, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa4c{width:0.75in;background-color:rgba(255, 200, 181, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa56{width:0.75in;background-color:rgba(255, 121, 88, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa57{width:0.75in;background-color:rgba(255, 115, 82, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa60{width:0.75in;background-color:rgba(255, 0, 0, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa6a{width:0.75in;background-color:rgba(92, 52, 255, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa6b{width:0.75in;background-color:rgba(80, 43, 255, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa74{width:0.75in;background-color:rgba(25, 8, 255, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa75{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa7e{width:0.75in;background-color:rgba(255, 225, 214, 1.00);vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa7f{width:0.75in;background-color:rgba(250, 247, 255, 1.00);vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa88{width:0.75in;background-color:rgba(84, 46, 255, 1.00);vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa92{width:0.75in;background-color:rgba(255, 0, 0, 1.00);vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa9c{width:0.75in;background-color:rgba(251, 248, 255, 1.00);vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e00cfa9d{width:0.75in;background-color:rgba(0, 0, 255, 1.00);vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing='true' class='cl-e017a01e'><thead><tr style=\"overflow-wrap:break-word;\"><th  rowspan=\"2\"class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">Type of diseases</span></p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">coefficient of IFN-gamma by Th1</span></p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">coefficient of TNF-alpha by Th1</span></p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">coefficient of TGF-beta by Treg</span></p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">coefficient of IL-10 by Treg</span></p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">activation of Th1 cells</span></p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">activation of Th2 cells</span></p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">activation of Th17 cells</span></p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">activation of Th17 cells</span></p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">activation of Treg cells</span></p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">activation of Treg cells</span></p></th></tr><tr style=\"overflow-wrap:break-word;\"><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\">NA</p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\">NA</p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\">NA</p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\">NA</p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\">NA</p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\">NA</p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\">NA</p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\">NA</p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\">NA</p></th><th class=\"cl-e00cf9e8\"><p class=\"cl-e00c9fc0\">NA</p></th></tr></thead><tbody><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-e00cf9fc\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">Type 1</span>NA</p></td><td class=\"cl-e00cf9fd\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">64.7%</span></p></td><td class=\"cl-e00cfa06\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-2.6%</span></p></td><td class=\"cl-e00cfa10\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-54.6%</span></p></td><td class=\"cl-e00cfa11\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">141.7%</span></p></td><td class=\"cl-e00cfa1a\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-2.0%</span></p></td><td class=\"cl-e00cfa24\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">15.8%</span></p></td><td class=\"cl-e00cfa25\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-100.0%</span></p></td><td class=\"cl-e00cfa25\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-100.0%</span></p></td><td class=\"cl-e00cfa2e\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">269.4%</span></p></td><td class=\"cl-e00cfa2e\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">332.7%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-e00cf9fc\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">Type 2</span>NA</p></td><td class=\"cl-e00cfa38\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-25.3%</span></p></td><td class=\"cl-e00cfa42\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-2.7%</span></p></td><td class=\"cl-e00cfa43\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-41.8%</span></p></td><td class=\"cl-e00cfa4c\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">81.2%</span></p></td><td class=\"cl-e00cfa1a\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-2.1%</span></p></td><td class=\"cl-e00cfa56\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">16.2%</span></p></td><td class=\"cl-e00cfa25\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-100.0%</span></p></td><td class=\"cl-e00cfa25\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-100.0%</span></p></td><td class=\"cl-e00cfa57\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">264.9%</span></p></td><td class=\"cl-e00cfa57\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">327.2%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-e00cf9fc\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">Type 3</span>NA</p></td><td class=\"cl-e00cfa60\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">243,047.1%</span></p></td><td class=\"cl-e00cfa60\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">19.8%</span></p></td><td class=\"cl-e00cfa60\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">2,047,265.1%</span></p></td><td class=\"cl-e00cfa6a\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-86.6%</span></p></td><td class=\"cl-e00cfa60\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">6.8%</span></p></td><td class=\"cl-e00cfa6b\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-89.9%</span></p></td><td class=\"cl-e00cfa25\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-100.0%</span></p></td><td class=\"cl-e00cfa25\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-100.0%</span></p></td><td class=\"cl-e00cfa25\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-100.0%</span></p></td><td class=\"cl-e00cfa74\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-98.7%</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-e00cfa75\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">Type 4</span>NA</p></td><td class=\"cl-e00cfa7e\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">38,189.9%</span></p></td><td class=\"cl-e00cfa7f\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-3.6%</span></p></td><td class=\"cl-e00cfa88\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-88.8%</span></p></td><td class=\"cl-e00cfa92\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">281.5%</span></p></td><td class=\"cl-e00cfa9c\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-3.1%</span></p></td><td class=\"cl-e00cfa92\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">24.1%</span></p></td><td class=\"cl-e00cfa9d\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-100.0%</span></p></td><td class=\"cl-e00cfa9d\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">-100.0%</span></p></td><td class=\"cl-e00cfa92\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">378.7%</span></p></td><td class=\"cl-e00cfa92\"><p class=\"cl-e00c9fc0\"><span class=\"cl-e004b242\">467.7%</span></p></td></tr></tbody></table></div>\n```\n\n:::\n:::\n\n\nOne of the major advantages of `flextable` lies in its ability to save the generated flextable object in a variety of formats, including `docx`, and `html`, as illustrated in @lst-flextable-output (or even several ones simultaneously).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{#lst-flextable-output .r .cell-code  lst-cap=\"Flextable multiple outputs.\"}\nsave_as_html(relative_parameter_variations_flextable,\n  path = \"../../results/Table8.html\",\n  title = \"Table 8: Parameter variations per disease subtype.\"\n)\n\nsave_as_docx(relative_parameter_variations_flextable,\n  path = \"../../results/Table8.docx\",\n  title = \"Table 8: Parameter variations per disease subtype.\"\n)\n```\n:::\n\n\n\n## Treatment outcome and patient stratification\n\nThe objective of this section is to predict the efficiency of a novel anti-TNF-$\\alpha$ treatment, assuming that the blocking treatment is equivalent to force the concentration of TNF-$\\alpha$ to remain zero, and calculate the change of other variables at the **steady-state concentrations**. \n\nSecond objective is to determine the efficiency of the treatment conditionned to the *patient endotype* determined using *patient stratification* approaches. \n\n\n### Load Free Parameter variations in different types of diseases\n\n**Since the results of parameter estimation reported in @sec-parameter-estimation differ significantly from the results reported in the original paper, *Table 8*, [@lo2016po, pp. 13](https://journals.plos.org/plosone/article/figure?id=10.1371/journal.pone.0165782.t008), we directly retrieve in that section the original estimates from @lo2016po**.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n## Prepare parameter variations for each of the four patient subtypes ----\nhealthy_model <- suppressWarnings(loadModel(\"../../models/team_2016_final_model_lo2016_2025_05_13.cps\"))\n\n# retrieve parameter mapping\nparameters_per_clusters <- getParameters(c(\"(Prod of Ig from T1).k1\",\n                          \"(Prod of Ia from T1).k1\",\n                          \"(Prod of Ib from Tr).k1\",\n                          \"(Prod of I10 from Tr).v10r\",\n                          \"(Induction of T1 from M).s12\",\n                          \"(Induction of T2).s4\",\n                          \"(Induction of T17).s21\",\n                          \"(Induction of T17).s6\",\n                          \"(Induction of Tr).sb\",\n                          \"(Induction of Tr).s10\"), model = healthy_model)\n\n# retrieve parameter variations specific to each disease subtype ...\npatient_group <- c(\"Type1\", \"Type2\", \"Type3\", \"Type4\")\nparameters_per_clusters <- parameters_per_clusters |> \n  dplyr::inner_join(readr::read_csv(\"../../data/IBD subgroups.csv\", show_col_types = FALSE), by = \"key\") |> \n  rename(healthy = value) |> \n  dplyr::select(-mapping) |> \n  # ... and convert relative ratios to absolute\n  dplyr::mutate(across(all_of(patient_group), \\(x) healthy *  (1 + x/100)))\n\n# run healthy steady state\nhealthy_steaty_state <- runSteadyState(\n  calculate_jacobian = FALSE,\n  model = healthy_model)$species |> \n  dplyr::select(name, concentrationH = concentration) |> \n  filter (name %in% c(\"I6\", \"I10\", \"Ia\", \"T1\", \"T2\",\"T17\", \"Tr\", \"Ig\", \"Ib\"))\n```\n:::\n\n\n### Model the effect of TNF-alpha blockade\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n```r\nsteady_states_per_cluster <- purrr::map(patient_group, function(cluster) {\n  # without anti-TNF alpha treatment\n  disease_model_without_treatment <- healthy_model |> saveModelToString() |>  loadModelFromString() # <1>\n  setParameters(model = disease_model_without_treatment,  # <1>\n                key = parameters_per_clusters$key, # <1>\n                value = parameters_per_clusters[[cluster]])  # <1>\n  without_treatment_steady_state <- runSteadyState(  # <1>\n    calculate_jacobian = FALSE, # <1>\n    model = disease_model_without_treatment)$species |> # <1>\n    dplyr::select(name, concentration) |>  # <1>\n    inner_join(healthy_steaty_state, by = \"name\") |>  # <1>\n    mutate (concentration = 100* (concentration - concentrationH) / concentrationH) |> # <1>\n    dplyr::select(-concentrationH) |> # <1>\n    mutate(cluster = cluster, category = \"untreated\") # <1>\n    \n  # with anti-TNF alpha treatment\n  disease_model_with_treatment <- suppressWarnings(disease_model_without_treatment |> \n                                                     saveModelToString() |>  \n                                                     loadModelFromString())\n  setSpecies(key = \"Ia{compartment}\", # <2>\n             initial_concentration = 0, # <2>\n             type =\"fixed\", # <2>\n             model = disease_model_with_treatment) # <2>\n  with_treatment_steady_state <- runSteadyState( # <3>\n    calculate_jacobian = FALSE, # <3>\n    model = disease_model_with_treatment)$species |> # <3>\n    dplyr::select(name, concentration) |> # <3>\n    inner_join(healthy_steaty_state, by = \"name\") |> # <3>\n    mutate (concentration = 100* (concentration - concentrationH) / concentrationH) |> # <3>\n    dplyr::select(-concentrationH) |> # <3>\n    tibble::add_row(name = \"Ia\", concentration = 0) |> # <3>\n    mutate(cluster = cluster, category = \"treated\") # <3>\n    \n  return (rbind(without_treatment_steady_state, with_treatment_steady_state))\n  \n}) |> dplyr::bind_rows() # <4>\n```\n1. Estimate *steady-state* conditions for each of the four patient subgroups identified, without anti-TNF-$\\alpha$ treatment.\n2. Constrain TNF-$\\alpha$ to remain `fixed` and **null** by setting the initial concentration level to $0$. **Both parameters are required** to ensure absence of TNF-$\\alpha$.\n3. Predict the new *steady-state* conditions after therapeutic treatment. \n4. `dplyr::bind_rows()` merges a list of `data.frame` into a single one. \n\n### Simulation visualisations of the fold changes of the cytokine and T cell concentrations\n\nWe have reproduced *Fig.3* from @lo2016po, pp. 13, in @fig-treatment-blockade, using a combination of `ggplot2`for individual barplot representations and `cowplot` for individual 'ggplot' concatenations. \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n\n# Reproduce boxplots of Figure 3, pre and post-treatment ----\n# Format dataset for plotting\nsteady_states_per_cluster_plot <- steady_states_per_cluster |> \n  mutate (name = factor (name, \n                         levels = c(\"I6\", \"I10\", \"Ia\",  \"T1\", \"T2\",\n                                    \"T17\", \"Tr\", \"Ig\", \"Ib\"),\n                         labels = c(\"IL-6\", \"IL-10\", \"TNF-alpha\", \"Th1\", \"Th2\", \n                                    \"Th17\", \"Treg\", \"IFN-gamma\", \"TFG-beta\"), \n                         ordered = TRUE),\n          category  = factor(category, \n                           levels = c(\"untreated\", \"treated\"), ordered = TRUE))\n\ncluster_labels <- c(\"Type 1: Th1\\\\uparrow Th2\\\\downarrow\",\n                    \"Type 2: Th1\\\\downarrow Th2\\\\uparrow\", \n                    \"Type 3: Th1\\\\uparrow Th2\\\\uparrow\",\n                    \"Type 4: Th1\\\\downarrow Th2\\\\downarrow\") \nnames(cluster_labels) <- c(\"Type1\", \"Type2\", \"Type3\", \"Type4\")\n\n\n### Retrieve legend ----\nglobal_plot <- ggplot(data = steady_states_per_cluster_plot, \n                      mapping = aes(x = name, y = concentration, fill = category)) +\n  geom_col(position = \"dodge\") +\n  scale_fill_manual(name =\"Treatment\", values=c(\"blue\", \"red\")) + \n  guides(color = guide_legend(nrow = 1)) +\n  theme(legend.position = \"bottom\") \n\n### Generate bar plot for each disease subtype ----\nlist_plots <- purrr::imap(cluster_labels, ~ ggplot(data = steady_states_per_cluster_plot |> filter(cluster==.y), \n                                                   mapping = aes(x = name, y = concentration, fill = category)) +\n                            geom_col(position = \"dodge\")+\n                            labs(x = NULL, y = NULL) +\n                            scale_fill_manual(name =\"Treatment\", values=c(\"blue\", \"red\")) +\n                            theme_minimal() +\n                            theme(panel.grid.major = element_blank(),\n                                  legend.position = \"none\", plot.title = element_text(hjust = 0.5)) +\n                            ggtitle(TeX(.x)))\n\n### Combine barplots into a 2x2 grid ----\nplot_grid_combined <- cowplot::plot_grid(plotlist = list_plots, \n  ncol = 2, align = \"hv\", axis = \"tblr\") \n\nx_label <- ggdraw() + draw_label(\"Cell Species\", x = 0.5, y = 0.5)\ny_label <- ggdraw() + draw_label(\"ODE Parameters\", x = 0.5, y = 0.5, angle = 90)\n\n# Add global y label\nplot_grid_combined <- cowplot::plot_grid(y_label,\n  plot_grid_combined,\n  nrow = 1,\n  rel_widths = c(0.1, 1)  # Adjust width for the legend\n)\n\nlegend_plot <- get_legend_temp(global_plot)\n\n# Add global x label\nplot_grid_combined <- cowplot::plot_grid(plot_grid_combined, \n                   x_label,\n                   legend_plot,\n                   nrow = 2, ncol =1,\n                   rel_heights = c(1, 0.1)  # Adjust width for the legend\n)\n\nplot_grid_combined <- cowplot::plot_grid(\n  plot_grid_combined,\n  legend_plot,\n  nrow = 2,\n  rel_heights = c(1, 0.1)  # Adjust width for the legend\n)\n\nplot_grid_combined\n```\n\n::: {.cell-output-display}\n![Simulation results of the **fold changes** of the cytokine and T-cell concentrations when TNF-$\\alpha$ is completely blocked in the four group of identified patients. Blue bars represent the results of pre-treatment; red bars represent the results of post-treatment with TNF-$\\alpha$ blockage. Reproduction of [@lo2016po, pp. 13], Fig.3.](patient_stratification_files/figure-html/fig-treatment-blockade-1.png){#fig-treatment-blockade fig-align='center' width=95%}\n:::\n:::\n\n\n\n",
    "supporting": [
      "patient_stratification_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/tabwid-1.1.3/tabwid.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/tabwid-1.1.3/tabwid.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}